<%- include('../partials/header') %>


<main>

<div class="mt-20">
            <h1 class="flex items-center justify-center font-bold text-blue-600 text-md lg:text-3xl">OneCart Checkout 
            </h1>
        </div>
        <div class="container p-12 mx-auto">
            <div class="flex flex-col w-full px-0 mx-auto md:flex-row">
                <div class="flex flex-col md:w-full">
                 <section>

                    <h2 class="mb-4 font-bold md:text-xl text-heading text-center">Personal Details</h2>
                    <div class="flex-row items-center mb-4">
                    <ul class="text-center space-y-1 text-gray-900 list-none list-inside dark:text-gray-900">
                        <li>
                           <span>Name : <%= getUser.name %> </span>
                        </li>
                        <li>
                            <span>Email : <%= getUser.email %> </span>
                        </li>
                        <li>
                            <span>Phone : <%= getUser.phone %> </span>
                        </li>
                    </ul>
                </div>
                 </section>
                       

                
                    <form class=" mx-auto mt-6" method="post" action>
                        <h2 class="mb-4 mt-6 font-bold md:text-xl text-heading text-center">Shipping Address
                        </h2>
                        <div class="flex-row items-center mb-4">

                        <section>
                       <div>
                            <input  id="default-radio-1" type="radio" value="Cash on Delivery" name="paymentMethod" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300  dark:bg-gray-700 dark:border-gray-600">
                            <label  for="paymentMethod" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-900">Permenant Address</label>
                                <ul class="max-w-md text-sm space-y-1 text-gray-900 list-none list-inside dark:text-gray-900">
                                    <li>
                                       <%= address.name %> 
                                       </li>
                                       <li>
                                       <%= address.address %>,
                                       <%= address.city %> 
                                       <li>
                                            <%= address.pincode %>,
                                       <%= address.state %>,
                                       <%= address.country %>
                                        </li>
                                </ul>
    
                        </div>
                        </section>
                       
            <section class="mt-5">
                <div>
                    <input  id="default-radio-1" type="radio" value="Cash on Delivery" name="paymentMethod" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300  dark:bg-gray-700 dark:border-gray-600">
                    <label  for="paymentMethod" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-900">New Address</label>
                        <ul class="max-w-md text-sm space-y-1 text-gray-500 list-none list-inside dark:text-gray-900">
                            <li>
                                At least 10 characters (and up to 100 characters)
                            </li>
                        </ul>
                  </div>
            </section>
                 <div>

                <section class="mt-12">
                    <h3 class="text-lg font-bold text-[#333] mb-6">Coupons</h3>
                
                    <input id="couponSearch" class="w-56 h-9 border border-gray-950" type="text" placeholder="search coupon">
                        <select id="couponValues" class="bg-gray-50 h-9 w-56 mt-5 border border-gray-300 text-gray-900 text-sm  focus:ring-blue-500 focus:border-blue-500 block p-1.5  dark:border-gray-600 dark:placeholder-gray-400 dark:text-gray-900 dark:focus:ring-blue-500 dark:focus:border-blue-500">
                            <option selected disabled  selected> Available Coupons </option>
                            <% coupon.forEach(coup => { %>
                            <option value="<%= coup.discount %>"><%= coup.couponCode %></option>
                            
                            <% }) %>
                        </select>
                    <div class="flex gap-6 max-sm:flex-col mt-5">
                      <button id="addCoupon" type="button" class="rounded-md px-6 py-1.5 w-32 text-sm font-thin bg-cyan-400 text-gray-900 hover:bg-[#222] hover:text-white">
                        Add Coupon
                    </button>
                    </div>
                </section>

        <section  class="mt-12">
            <h3 class="text-lg font-bold text-[#333] mb-6">Payment Method</h3>
                <div class="flex-col  mb-4">
                    <input  id="default-radio-1" type="radio" value="Cash on Delivery" name="paymentMethod" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300  dark:bg-gray-700 dark:border-gray-600">
                    <label  for="paymentMethod" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-900">Cash on Delivery</label>
        
                    <input id="default-radio-2" type="radio" value="Razor Pay" name="paymentMethod" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300  dark:bg-gray-700 dark:border-gray-600">
                    <label for="paymentMethod" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-900">Razor Pay</label>
                </div>
        </section>

        <section>
        <div class="flex gap-6 max-sm:flex-col mt-10">
            <button type="button" class="rounded-md px-6 h-12 py-3 w-full text-sm font-semibold bg-stone-300 hover:bg-gray-100 border-2 text-[#333]">Cancel</button>
            <button id="placeOrder" type="button" class="rounded-md h-12 px-6 py-1 w-full text-sm font-semibold bg-[#50b367] text-white hover:bg-[#222]">
                Complete Purchase
                 </button>
              </div>
        </section>
       </div>
            </div>
           </form>
                </div>
                <div class="flex flex-col w-full ml-0 lg:ml-12 lg:w-2/5">
                    <div class="pt-12 md:pt-0 2xl:ps-4 bg-white shadow-md rounded-md">
                        <h2 class="text-xl font-bold">Order Summary
                        </h2>
                        <div class="mt-8">
                            <% products.forEach( item => { %>
                                <div class="flex-col space-x-4 mt-4 mb-4">
                                    <div>
                                        <img src="/product_images/<%= item.productImage[0] %>" alt="image"
                                            class="w-24 h-28">
                                    </div>
                                    <div>
                                        <h2 class="text-md font-bold"><%= item.productName %></h2>
                                        <ul>
                                            <li class="flex text-xs flex-wrap gap-4">Size : <span class="text-end"><%= item.size %> </span></li>
                                            <li class="flex text-xs flex-wrap gap-4">Quantity : <span class="text-end"><%= item.stock %> </span></li>
                                            <li class="flex text-xs flex-wrap gap-4">Total Price : <span class="text-end"><%=  item.price %></span></li>
                                        </ul>
                                       
                                    </div>
                                  
                                </div>
                                <% }) %>
                            </div>
                        </div>
                    
                        
                        <div
                            class="flex items-center w-full py-4 text-xs font-thin border-b border-gray-300 lg:py-5 lg:px-3 text-heading last:border-b-0 last:text-base last:pb-0">
                            Subtotal<span id="subTotal" class="ml-2"> <%= totalPrice %>₹ </span></div>
                        <div
                            class="flex items-center w-full py-4 text-xs font-thin border-b border-gray-300 lg:py-5 lg:px-3 text-heading last:border-b-0 last:text-base last:pb-0">
                            Shipping Tax<span class="ml-2">00.00₹</span>
                        </div>
                        <div
                            class="flex items-center w-full py-4 text-xs font-thin border-b border-gray-300 lg:py-5 lg:px-3 text-heading last:border-b-0 last:text-base last:pb-0">
                            Discount Amount<span id="discountAmount" class="ml-2">00.00₹</span>
                        </div>
                        <div
                            class="flex items-center w-full py-4 text-sm font-semibold border-b border-gray-300 lg:py-5 lg:px-3 text-heading last:border-b-0 last:text-base last:pb-0">
                            Total<span id="totalPrice" class="ml-2"> <%= totalPrice %></span>₹</div>
                    </div>
                </div>
            </div>
        </div>


</main>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>

    //<------------ order creating -------------->
document.addEventListener("DOMContentLoaded", function() {
    const placeOrderButton = document.getElementById('placeOrder');
    placeOrderButton.addEventListener('click', function() {
        const paymentMethod = document.getElementsByName('paymentMethod');
    let selectedValue = "";
    const totalPriceElement = document.getElementById('totalPrice');
        const totalPrice = parseFloat(totalPriceElement.textContent);
    paymentMethod.forEach(radio => {
        if (radio.checked) {
            selectedValue = radio.value;
        }
    });
if(!selectedValue){
            alert('Please select a payment method');
        }

   //<------------ for cash on delevery -------------->
      if(selectedValue == "Cash on Delivery"){
        const paymentMethod = selectedValue;
        fetch('/placeOrder',{
                        method:"POST",
                        headers:{
                            "Content-Type" : "application/json"
                        },
                        body:JSON.stringify({
                            totalPrice : totalPrice,
                            paymentMethod : paymentMethod
                        })
                        }).then(() => {
                            window.location.href = '/orderSuccess'
                        })}else{
       //<------------ for Razor pay -------------->
            var orderId;
            fetch('/create-order', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                "totalPrice": totalPrice
            })})
            .then(response => response.json())
            .then(data => {
            orderId = data.id; 
          }).catch(error => {
        console.error('Error:', error); 
      });
        var options = {
            "key": "rzp_test_3aIOQlQc4egRLE", 
            "amount": totalPrice * 100,
            "currency": "INR",
            "name": "OneCart", 
            "description": "Test Transaction",
            "image": "/images/onecart-log.avif",
            "order_id": orderId, 
            "handler": function (response){
                const paymentMethod = selectedValue;
                        fetch('/placeOrder',{
                        method:"POST",
                        headers:{
                            "Content-Type" : "application/json"
                        },
                        body:JSON.stringify({
                            totalPrice : totalPrice,
                            paymentMethod : paymentMethod
                          })
                            }).then(() => {
                                    window.location.href = '/orderSuccess'
                                })
                // alert(response.razorpay_payment_id);
                // alert(response.razorpay_order_id);
                // alert(response.razorpay_signature)
            },
        "prefill": { 
            "name": "Gaurav Kumar", //your customer's name
            "email": "gaurav.kumar@example.com", 
            "contact": "9000090000"  //Provide the customer's phone number for better conversion rates 
        },
        "notes": {
            "address": "Razorpay Corporate Office"
        },
        "theme": {
            "color": "#3399cc"
        }};
        var rzp1 = new Razorpay(options);
        rzp1.on('payment.failed', function (response){
                alert(response.error.code);
                alert(response.error.description);
                alert(response.error.source);
                alert(response.error.step);
                alert(response.error.reason);
                alert(response.error.metadata.order_id);
                alert(response.error.metadata.payment_id);
            });
            document.getElementById('placeOrder').onclick = function(e){
                rzp1.open();
                e.preventDefault();
                }}})
            });


   //<------------ coupon applying -------------->
const addCouponButton = document.getElementById('addCoupon');
addCouponButton.addEventListener('click', () => {
    const couponSearch = document.getElementById('couponSearch').value;

    if(couponSearch){
        
        const total = document.getElementById('totalPrice').innerText;
       fetch('/couponSearch',{
        method:"POST",
          headers:{
              "Content-Type" : "application/json"
          },
          body:JSON.stringify({
              searchValue : couponSearch,
              totalPrice : total
            })
       }).then(response => {
    if (response.ok) {
        return response.json()}
            throw new Error('Network response was not ok.');
        })
        .then(data => {
            let discount = parseFloat(data.discountPrice);
      
            const subTotal = parseFloat(document.getElementById('subTotal').innerText);




const discountAmount = (subTotal * discount) / 100;

const total = document.getElementById('totalPrice').innerText = subTotal - discountAmount ;

const discountDisplay = document.getElementById('discountAmount').innerText = discountAmount;

console.log('Selected coupon:', selectedCoupon);
        });
          
        
        

      

    }else{
        if(couponSearch){
            alert('Cannot select multiple options')
        }else{
            const subTotal = parseFloat(document.getElementById('subTotal').innerText);
            const discount = parseFloat(document.getElementById('couponValues').value);
            const discountAmount = (subTotal * discount) / 100;
            const total = document.getElementById('totalPrice').innerText = subTotal - discountAmount;
            const discountDisplay = document.getElementById('discountAmount').innerText = discountAmount;
        }
    }
});





   </script>

        <%- include('../partials/footer') %>